/* Activ'Map Plugin
 * Copyright (c) 2015 Pandao
 * Documentation : /doc/index.html
 */
!function($){$.activmap={defaults:{places:[],lat:51.5286416,lng:-.1015987,zoom:10,cluster:!0,mapType:"roadmap",posPanel:"left",showPanel:!0,radius:0,country:"uk",autogeolocate:!1,icon:"images/icons/marker-hotel.png",styles:[{featureType:"landscape.man_made",elementType:"geometry",stylers:[{color:"#f7f1df"}]},{featureType:"landscape.natural",elementType:"geometry",stylers:[{color:"#d0e3b4"}]},{featureType:"landscape.natural.terrain",elementType:"geometry",stylers:[{visibility:"off"}]},{featureType:"poi",elementType:"labels",stylers:[{visibility:"off"}]},{featureType:"poi.business",elementType:"all",stylers:[{visibility:"off"}]},{featureType:"poi.medical",elementType:"geometry",stylers:[{color:"#fbd3da"}]},{featureType:"poi.park",elementType:"geometry",stylers:[{color:"#bde6ab"}]},{featureType:"road",elementType:"geometry.stroke",stylers:[{visibility:"off"}]},{featureType:"road",elementType:"labels",stylers:[{visibility:"off"}]},{featureType:"road.highway",elementType:"geometry.fill",stylers:[{color:"#ffe15f"}]},{featureType:"road.highway",elementType:"geometry.stroke",stylers:[{color:"#efd151"}]},{featureType:"road.arterial",elementType:"geometry.fill",stylers:[{color:"#ffffff"}]},{featureType:"road.local",elementType:"geometry.fill",stylers:[{color:"black"}]},{featureType:"transit.station.airport",elementType:"geometry.fill",stylers:[{color:"#cfb2db"}]},{featureType:"water",elementType:"geometry",stylers:[{color:"#a2daf2"}]}]}},$.fn.extend({activmap:function(settings){function handleNoGeolocation(e){1==e?(console.log("Geolocation service failed."),initialLocation=latlng):(console.log("Your browser doesn't support geolocation."),initialLocation=latlng),map.setCenter(initialLocation)}var s=$.extend({},$.activmap.defaults,settings),latlng=new google.maps.LatLng(s.lat,s.lng),opendInfoWindow=null,markers=[],infoWindow=[],ids=[],bounds,num_places=0,old_results=0,mapTypeId=google.maps.MapTypeId.ROADMAP;("satellite"==s.mapType||"perspective"==s.mapType)&&(mapTypeId=google.maps.MapTypeId.HYBRID);var map=new google.maps.Map(document.getElementById("activmap-canvas"),{zoom:s.zoom,center:latlng,mapTypeId:mapTypeId,styles:s.styles});_geolocate=function(){navigator.geolocation?(browserSupportFlag=!0,navigator.geolocation.getCurrentPosition(function(e){initialLocation=new google.maps.LatLng(e.coords.latitude,e.coords.longitude),map.setCenter(initialLocation)},function(){handleNoGeolocation(browserSupportFlag)})):(browserSupportFlag=!1,handleNoGeolocation(browserSupportFlag))},1==s.autogeolocate&&_geolocate(),$("#activmap-geolocate").length&&$("#activmap-geolocate").click(function(){_geolocate()}),"perspective"==s.mapType&&map.setTilt(45);var activmap_canvas=$("#activmap-canvas"),activmap_places=$("#activmap-places"),map_w=activmap_canvas.width(),cont_w=activmap_places.outerWidth();if(s.cluster){var markerCluster=new MarkerClusterer(map,markers,{maxZoom:12,gridSize:40});markerCluster.setIgnoreHidden(!0)}if(s.showPanel?("left"==s.posPanel&&(activmap_places.css({left:-cont_w,right:"auto"}),activmap_canvas.css({"float":"right"})),"right"==s.posPanel&&(activmap_places.css({right:-cont_w,left:"auto"}),activmap_canvas.css({"float":"left"}))):activmap_places.hide(),$("#activmap-location").length){var options={types:["address"],componentRestrictions:{country:s.country}},input=document.getElementById("activmap-location");autocomplete=new google.maps.places.Autocomplete(input,options),google.maps.event.addListener(autocomplete,"place_changed",function(){var e=autocomplete.getPlace();e.geometry.viewport?map.fitBounds(e.geometry.viewport):(latlng=e.geometry.location,map.setCenter(e.geometry.location),map.setZoom(10))})}_init=function(){$.each(s.places,function(e,a){a.num_tags=0;var t,o=new google.maps.LatLng(a.lat,a.lng),i=""!=a.icon&&void 0!=a.icon?a.icon:s.icon,n=new google.maps.Marker({map:map,position:o,icon:i,title:a.title});t=""!=a.img?'<div class="activmap-brand"><img src="'+a.img+'"></div><h4 class="activmap-title">'+a.title+"</h4>":'<h4 class="activmap-title">'+a.title+"</h4>",""!=a.address&&(t+=a.address+"<br>"),""!=a.phone&&(t+=a.phone+"<br>"),""!=a.url&&(t+='<a href="'+a.url+'" target="_blank">'+a.url+"</a><br>"),infoWindow[e]=new google.maps.InfoWindow({content:t,position:o}),google.maps.event.addListener(n,"click",function(){null!=opendInfoWindow&&opendInfoWindow.close(),infoWindow[e].open(map,n),opendInfoWindow=infoWindow[e],$(".activmap-place").removeClass("active"),$("#activmap-place_"+e).addClass("active"),activmap_places.scrollTop(activmap_places.scrollTop()+$("#activmap-place_"+e).position().top)}),n.setVisible(!1),a.marker=n,markers.push(n),activmap_places.append('<div class="activmap-place" id="activmap-place_'+e+'"><h3>'+a.title+"</h3><p>"+a.address+"</p></div>"),$.each(a.tags,function(a,t){void 0===ids[t]&&(ids[t]=[]),ids[t].push(e)})}),$('input[name="activmap_radius"]').change(function(){s.radius=$(this).val(),$('input[name="marker_type[]"]').each(function(){_update_places_tag($(this))}),_update_map()}),$('input[name="marker_type[]"]').change(function(){_update_places_tag($(this)),_update_map()}),$("#activmap-reset").click(function(){return $('input[name="marker_type[]"]').prop("checked",!1),$('input[name="marker_type[]"]').each(function(){_update_places_tag($(this))}),_update_map(),!1}),$(".activmap-place").click(function(){var e=$(this).attr("id").replace("activmap-place_","");google.maps.event.trigger(s.places[e].marker,"click")}),$(window).resize(function(){_update_map()}),$('input[name="marker_type[]"]:checked').each(function(){_update_places_tag($(this))}),_update_map()},_rad=function(e){return e*Math.PI/180},_get_distance=function(e,a){var t=6378137,s=_rad(a.lat()-e.lat()),o=_rad(a.lng()-e.lng()),i=Math.sin(s/2)*Math.sin(s/2)+Math.cos(_rad(e.lat()))*Math.cos(_rad(a.lat()))*Math.sin(o/2)*Math.sin(o/2),n=2*Math.atan2(Math.sqrt(i),Math.sqrt(1-i)),l=t*n;return l},_update_map=function(){map_w=$("#activmap-wrapper").width(),num_places>0?0==old_results?s.showPanel?("left"==s.posPanel&&activmap_places.stop(!0,!0).animate({left:0},600),"right"==s.posPanel&&activmap_places.stop(!0,!0).animate({right:0},600),activmap_places.is(":visible")?activmap_canvas.animate({width:map_w-cont_w},600,function(){map.fitBounds(bounds),s.cluster&&markerCluster.repaint()}):(map.fitBounds(bounds),s.cluster&&markerCluster.repaint())):(map.fitBounds(bounds),s.cluster&&markerCluster.repaint()):(activmap_canvas.width(s.showPanel&&activmap_places.is(":visible")?map_w-cont_w:map_w),map.fitBounds(bounds),s.cluster&&markerCluster.repaint()):(null!=opendInfoWindow&&opendInfoWindow.close(),s.showPanel&&activmap_places.is(":visible")?(activmap_canvas.animate({width:map_w},600),"left"==s.posPanel&&activmap_places.animate({left:-cont_w},600),"right"==s.posPanel&&activmap_places.animate({right:-cont_w},600)):activmap_canvas.width(map_w),s.cluster&&markerCluster.repaint(),map.setZoom(s.zoom),map.setCenter(latlng));var e=google.maps.event.addListener(map,"idle",function(){map.getZoom()>16&&map.setZoom(16),google.maps.event.removeListener(e)});old_results=num_places},_update_places_tag=function(e){var a=e.val();if(void 0!==ids[a]){$.each(ids[a],function(a,t){s.places[t].num_tags=0,e.prop("checked")===!0&&(0==s.radius||_get_distance(s.places[t].marker.position,latlng)<=1e3*s.radius)?(s.places[t].num_tags++,s.places[t].marker.setVisible(!0),s.places[t].isVisible=!0,$("#activmap-place_"+t).show()):(s.places[t].num_tags>0&&s.places[t].num_tags--,0==s.places[t].num_tags&&(s.places[t].marker.setVisible(!1),s.places[t].isVisible=!1,$("#activmap-place_"+t).hide()))}),bounds=new google.maps.LatLngBounds;var t=0;$.each(s.places,function(e,a){1==a.isVisible&&(bounds.extend(a.marker.getPosition()),t++)}),num_places=t,$("#activmap-results-num").html(t+" result(s)")}},Array.isArray(s.places)?_init():$.ajax({url:s.places,dataType:"json",cache:!1,error:function(e,a,t){console.log(e),console.log(a),console.log(t)},success:function(data){var obj=eval(data);s.places=obj.places,_init()}})}})}(jQuery);
